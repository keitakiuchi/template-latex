# Output Guidelines

## Directory for analysis results
- **All analysis results (logs, CSVs, reports, etc.) must be written to `results/`.**
- The setup script (`setup.sh`) ensures this directory exists (`mkdir -p results`).
- Do **not** write result files elsewhere unless explicitly instructed.
- Unless otherwise directed, save any files generated by code to `results/` and commit them in your PR.
- Avoid overwriting existing files in `results/`; if a file already exists, append `_1`, `_2`, etc., to the filename.

## Directory for datasets
- Store all dataset files in the `data/` directory.
- The setup script (`setup.sh`) creates this directory (`mkdir -p data`).

# ğŸ‘‰ Overwrite & commit policy
- If a script updates an existing file in `data/`, **stage & commit the new
  version** on the same branch before opening / updating the PR.  Leaving the
  old snapshot in `main` defeats reproducibility.

## Verification
- At the end of each task, verify that the expected output files are present in `results/`.

### Commit policy for generated files
- If the analysis produces *any* new or updated files under `data/` or `results/`,
  **commit them on the same branch before opening / updating the PR**.
- Submitting only log files (or no files) is considered an incomplete task.

# Output Guidelines
- **ã™ã¹ã¦ã®è§£æçµæœãƒ•ã‚¡ã‚¤ãƒ«ã¯ `results/` ã«æ›¸ãå‡ºã™ã“ã¨ã€‚**
- æŒ‡ç¤ºãŒãªã„é™ã‚Šã€ã‚³ãƒ¼ãƒ‰ã§ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ `results/` ã«ä¿å­˜ã—ã¦ PR ã«å«ã‚ã‚‹ã“ã¨ã€‚
- åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ `_1`, `_2` ãªã©é€£ç•ªã‚’ä»˜ã‘ã¦ä¸Šæ›¸ãã‚’é¿ã‘ã‚‹ã€‚
- `setup.sh` ãŒ `results/` ã‚’å¿…ãšä½œæˆã™ã‚‹ã€‚

## ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ ¼ç´å ´æ‰€
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `data/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ãã“ã¨ã€‚
- `setup.sh` ãŒ `data/` ã‚’ä½œæˆã™ã‚‹ã€‚

# Analysis Execution Rules
1. è§£æã¯ **Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`*.py`)** ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã€‚
2. R ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€Python ã‹ã‚‰æ¬¡ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§å‘¼ã³å‡ºã™ã€‚
   - **`subprocess` çµŒç”±ã§ `Rscript` ã‚’å®Ÿè¡Œã™ã‚‹**
     ```python
     import subprocess, pathlib, datetime, sys
      out_file = pathlib.Path("results") / f"summary_{datetime.datetime.now():%Y%m%d_%H%M%S}.csv"
     subprocess.run(
         ["Rscript", "src/analysis/my_analysis.R", str(out_file)],
         check=True,
     )
     ```
   - **`rpy2` ã‚’ç”¨ã„ã¦ R ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§å®Ÿè¡Œã™ã‚‹**
     ```python
     from rpy2 import robjects
     robjects.r('''
       library(tidyverse)
       # â€¦R ã®å‡¦ç†â€¦
       write.csv(result, "results/inline_result.csv", row.names = FALSE)
     ''')
     ```
3. **`.R` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Codex ã«ç›´æ¥å®Ÿè¡Œã•ã›ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¦æ­¢**ã€‚
   å¿…ãš Python ãŒãƒãƒ–ã¨ãªã‚Šã€çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `results/` ã«é…ç½®ã™ã‚‹ã“ã¨ã€‚

## Encoding Rules
- ã‚³ãƒ¡ãƒ³ãƒˆä»¥å¤–ã®ã‚³ãƒ¼ãƒ‰è¡Œã§ã¯ **å…¨è§’æ–‡å­—ã‚’ä½¿ç”¨ã—ãªã„**ï¼ˆå¤‰æ•°åãƒ»æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å«ã‚€ï¼‰ã€‚
  - UI æ–‡å­—åˆ—ãªã©æ—¥æœ¬èªãŒå¿…è¦ãªå ´åˆã¯ *å¿…ãš* `# noqa: UTF-8` ä»˜ãã®
    æ–‡å­—åˆ—å®šæ•°ã«åˆ‡ã‚Šå‡ºã™ã€‚
4. è§£æçµ‚äº†å¾Œã€æœŸå¾…ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒ `results/` ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°ã‚¿ã‚¹ã‚¯ã‚’å¤±æ•—æ‰±ã„ã¨ã™ã‚‹ã€‚

# Verification
- ãƒ†ã‚¹ãƒˆã‚„ self-check ã®éš›ã¯ `results/` å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚„åå‰ã‚’ç¢ºèªã—ã¦åˆå¦åˆ¤å®šã‚’è¡Œã†ã€‚

# Error Handling & Diagnostics
When any step of the analysis fails (non-zero exit status, exceptions, or missing output in `results/`):

1. **Capture details**
   - Save `stdout`/`stderr` logs to `results/error_<timestamp>.log`.
   - Record the exact exit code and failing command or stack trace.

2. **Identify root cause**
   - Parse the log and classify the failure (e.g., missing package, path error, R script crash, permission issue).
   - Search the repository for relevant files or configuration that may be involved.

3. **Propose a fix**
   - Add a plaintext file `results/fix_<timestamp>.txt` that briefly explains
     - *What failed* (one sentence)
     - *Why it failed* (evidence or hypothesis)
     - *How to fix* (concrete steps or code snippet)
   - Keep the explanation under 30 lines. Use bullet points.

4. **Report in task output**
   - If running in Ask-mode, include a summary of the above in the final ChatGPT response.
   - If running in Code-mode (PR), include the same summary in the PR description under a section titled `### Failure Analysis`.

5. **Do not silently ignore errors**. A task is â€œdoneâ€ only when either
   - the analysis succeeds and `results/` contains the expected files, **or**
   - an error report *and* proposed fix have been produced as described above.

6. **Re-run policy**
   - After applying a proposed fix, re-run the failing step automatically once.
   - If it still fails, update the error report with the new findings instead of looping indefinitely.
7. **Missing dependencies during tests**
   - If a test fails because a required Python module is missing, append that module's name to `requirements.txt` and run the tests again.


## Execution Logging
- `notebooks_build/` ã¯ Git ç®¡ç†ã—ãªã„ï¼ˆ.gitignore æ¸ˆã¿ï¼‰ã€‚

### Notebook Generation
- `make notebook` ã¯ `analysis_steps/*.py` ã‚’ç•ªå·é †ã«èª­ã¿è¾¼ã¿ã€å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ 1 ã‚»ãƒ«ã¨ã—ã¦ã¾ã¨ã‚ãŸ Notebook `notebooks_build/execution_log.ipynb` ã‚’ç”Ÿæˆã™ã‚‹ã€‚
- ã‚»ãƒ«æ§‹æˆ:
  1. Markdown è¦‹å‡ºã— ã€Œ001 â€“ Summarize Datasetã€
  2. å¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨æ–‡ã® Code ã‚»ãƒ«
  ï¼ˆãƒ­ã‚°ã‚„æ¨™æº–å‡ºåŠ›ã¯ Notebook ã«ã¯å«ã‚ãªã„ï¼‰
- è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸è¦ã€‚æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿ã§å®Œçµã€‚

## Script Placement & Naming
1. è§£æç”¨ Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ **ã™ã¹ã¦ `analysis_steps/`** ã«ç½®ãã€‚
2. ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `NNN_<slug>.py` ã¨ã—ã€`NNN` ã¯ 001 ã‹ã‚‰é †ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã€‚
3. æ—¢å­˜ç•ªå·ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ã€‚æ–°è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã™ã‚‹éš›ã¯
   ãƒªãƒã‚¸ãƒˆãƒªã‚’èµ°æŸ»ã—ã¦ **æœ€å¤§ç•ªå·+1** ã‚’æ¡ç•ªã™ã‚‹ã“ã¨ã€‚
4. `<slug>` ã¯å‡¦ç†å†…å®¹ã‚’ç¤ºã™è‹±å°æ–‡å­—ï¼‹ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€‚20 æ–‡å­—ä»¥å†…ã€‚
5. ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã¯  
   ```bash
    python analysis_steps/NNN_<slug>.py
   ```
## Claude Code è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®éšå±¤ã¨è²¬å‹™

### 1. `.github/workflows/claude.yml` â€• GitHub Actions ã®â€œå¤–å´â€è¨­å®š
- **ç›®çš„**  
  - ã€Œã„ã¤ã€ã€Œã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã€Claude Code Action ã‚’èµ·å‹•ã™ã‚‹ã‹ã‚’å®šç¾©ã™ã‚‹ã€‚
  - å®Ÿè¡Œç’°å¢ƒï¼ˆãƒ©ãƒ³ãƒŠãƒ¼ OSãƒ»Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã€ãƒˆãƒ¼ã‚¯ãƒ³é¡ï¼ˆAPI Key / GITHUB_TOKENï¼‰ã‚’æ³¨å…¥ã™ã‚‹ã€‚
  - ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ concurrency åˆ¶å¾¡ãªã©ã€CI çš„ãªå‰å¾Œå‡¦ç†ã‚’è¡Œã†ã€‚
- **æ‰‹ã‚’å…¥ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°**  
  - Action ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹ã¨ãï¼ˆä¾‹: `@v1` â†’ `@v2`ï¼‰ã€‚  
  - æ–°ã—ã„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚„è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã«ãªã£ãŸã¨ãã€‚  
  - ãƒˆãƒªã‚¬ãƒ¼ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©ã€CI ãƒ¬ãƒ™ãƒ«ã®æ¡ä»¶ã‚’å¤‰ãˆãŸã„ã¨ãã€‚

### 2. `.claude/claude.yml` â€• Claude ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®â€œå†…å´â€è¨­å®š
- **ç›®çš„**  
  - Claude ã¸ã® system_promptï¼ˆç¦æ­¢ãƒ»æ¨å¥¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ«ãƒ¼ãƒ«ãªã©ï¼‰ã‚’å¸¸æ™‚èª­ã¿è¾¼ã¾ã›ã‚‹ã€‚  
  - `allowed_tools` ã§ Bash ã‚„ Edit ãªã© **å®Ÿè¡Œå¯èƒ½ã‚³ãƒãƒ³ãƒ‰ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ** ã‚’æ±ºã‚ã‚‹ã€‚  
  - 1 ã‚¿ã‚¹ã‚¯ã‚ãŸã‚Šã® `timeout_minutes` ã‚„ Claude å†…éƒ¨ã® `concurrency` ã‚’è¨­å®šã™ã‚‹ã€‚
- **æ‰‹ã‚’å…¥ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°**  
  - æ–°ã—ã„ç¤¾å†…ãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹: è§£æçµæœã¯å¿…ãš `results/` ã¸ï¼‰ãŒå¢—ãˆãŸã¨ãã€‚  
  - ä½¿ã„ãŸã„ Bash ã‚³ãƒãƒ³ãƒ‰ãŒå¢—ãˆãŸï¼æ¸›ã£ãŸã¨ãã€‚  
  - Claude ã®å¿œç­”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚„è‡ªå·±ãƒã‚§ãƒƒã‚¯è¦ç´„ã‚’æ›´æ–°ã—ãŸã„ã¨ãã€‚

### 3. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- **allowed_tools ã¯ `.claude/claude.yml` ã«ä¸€æœ¬åŒ–**  
  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å´ã§é‡è¤‡æŒ‡å®šã™ã‚‹ã¨ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸åæ˜ ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€‚  
- **ãƒ–ãƒ©ãƒ³ãƒåã¯ ASCII (a-z, 0-9, `-`, `_`) ã®ã¿ä½¿ç”¨ã™ã‚‹**  
  GitHub UI ã§ã®è¡¨ç¤ºãƒã‚°ã‚„ä¸€éƒ¨ãƒ„ãƒ¼ãƒ«ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã€‚
- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å´ã§ã¯ `config_file: .claude/claude.yml` ã ã‘æŒ‡å®š**  
  Claude Action ã«ã€Œå†…å´è¨­å®šã‚’ã“ã“ã‹ã‚‰èª­ã‚“ã§ã­ã€ã¨æ¸¡ã™ã ã‘ã«ç•™ã‚ã‚‹ã€‚  
- **Action ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å›ºå®šã‚¿ã‚°ã§ç®¡ç†**  
  ä¾‹: `anthropics/claude-code-action@v1`  
  `@main` ã‚„ `@beta` ã¯ Breaking Change ã‚’å³æ™‚æ‹¾ã†ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚  

### 4. å¤‰æ›´ãƒ•ãƒ­ãƒ¼ä¾‹
1. `.claude/claude.yml` ã« `allowed_tools: ["Bash(*)","Edit"]` ã‚’è¿½åŠ ã€‚  
2. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã® `Run Claude Code` ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®‰å®šç‰ˆã‚¿ã‚°ã¸æ›´æ–°ã€‚  
3. CI ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€`fix/claude-config` ãƒ–ãƒ©ãƒ³ãƒã§ PR ä½œæˆã€‚  
4. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã« main ã¸ãƒãƒ¼ã‚¸ã€‚  

> **Tip:**  
> `.claude/claude.yml` ã¯ **ãƒ­ãƒ¼ã‚«ãƒ« CLI ã‹ã‚‰ã®å‘¼ã³å‡ºã—** ã«ã‚‚è‡ªå‹•ã§é©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€  
> é–‹ç™ºè€…ã®æ‰‹å…ƒã¨ CI ç’°å¢ƒã§è¨­å®šãŒé£Ÿã„é•ã†å¿ƒé…ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

## Generated artefacts

```codex-policy
allow_overwrite:
  - path: data/**/*.csv
    max_size_mb: 20
```
